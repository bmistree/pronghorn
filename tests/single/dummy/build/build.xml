<project name="SingleDummyTest" default="compile" basedir=".">

  <!-- SingleDummyTest means that:
       Single -> Running on a single Pronghorn instance
       Dummy  -> Where we're simulating the connection to Flodlight
       Test   -> We're testing.
  -->
  
  <description>
    Test cases for pronghorn.
  </description>

  <dirname
    property="single_dummy_build_dir"
    file="${ant.file.RalphJavaLibTest}"
  />

  <!-- global properties for this build file -->

  <!-- Ralph dependency files -->
  <property
      name="ralph_dep_dir"
      location="${single_dummy_build_dir}/../../../../externals/ralph/"/>
  <property
      name="ralph_compiler_py"
      location="${ralph_dep_dir}/bin/emit_file.py"/>

  <property
      name="lib_build_path"
      location="${ralph_dep_dir}/ralph/java_lib/build"/>
  <property
      name="lib_class_path"
      location="${lib_build_path}/classes/"/>
  <property
      name="proto_class_path"
      location="${lib_build_path}/../protobuf-java-2.4.1.jar"/>
  <property
      name="ralph_compiler_py"
      location="${single_dummy_build_dir}/../../emit_file.py"/>


  <!-- Pronghorn libraries -->
  <property
      name="pronghorn_libs_build_path"
      location="${single_dummy_build_dir}/../../../../src/pronghorn/build"/>
  <property
      name="pronghorn_libs_class_path"
      location="${pronghorn_libs_build_path}/classes"/>
  
  <!-- Build files in singledummytests -->
  <property
      name="test_package"
      value="test_package"/>
  <property
      name="test_ralph_src_dir"
      location="${single_dummy_build_dir}/../ralph_src"/>
  <property
      name="test_harness_src_dir"
      location="${single_dummy_build_dir}/../test_src"/>
  <property
      name="test_ralph_emitted_dir"
      location="${single_dummy_build_dir}/../ralph_emitted"/>
  <property
      name="test_build_classes_dir"
      location="${single_dummy_build_dir}/classes"/>


  
  <!-- set up build directories for test -->
  <target name="init" description="setup build directories">
    <echo message="Setting up build directories for tests"/>
    <mkdir dir="${test_build_classes_dir}"/>
    <mkdir dir="${test_ralph_emitted_dir}"/>
  </target>


  <!-- COMPILING -->
  <!-- compile java libraries -->
  <target name="compile_libs" depends="init"
          description="compile library files">
    
    <ant antfile="${lib_build_path}/build.xml" target="compile_all" />
    <ant antfile="${pronghorn_libs_build_path}/build.xml" target="compile_all"/>
  </target>

  <!-- Compile to java -->
  <target name="translate_ralph" depends="init"
          description="translate ralph files">

    <exec executable="python" failonerror="true">
      <arg line="${ralph_compiler_py}"/>
      <arg line="${test_ralph_src_dir}/hardware_test.rph"/>
      <arg line="${test_ralph_emitted_dir}/HardwareTest.java"/>
      <arg line="${test_package}"/>
      <arg line="HardwareTest"/>
    </exec>
    
  </target>

  
  <target name="ralph_to_byte_code"
          depends="init,compile_libs"
          description="compile ralph files">
    <!-- Compile all ralph java to bytecode -->
    <javac
        srcdir="${test_ralph_emitted_dir}"
        destdir="${test_build_classes_dir}"
        classpath="${lib_class_path}:${pronghorn_libs_class_path}"
        debug="true"
        debuglevel="lines,vars,source"
        includeantruntime="false" />
  </target>

    
  <!-- compile ralph endpoints to java programs, including translating -->
  <target
      name="compile_ralph"
      depends="init,compile_libs,translate_ralph,ralph_to_byte_code"
      description="compile ralph files">
  </target>

  <!-- compile java test harnesses for ralph code  -->
  <target
      name="compile_ralph_tests"
      depends="init,compile_ralph"
      description="compile test harnesses for ralph code">
    <javac
        srcdir="${test_harness_src_dir}"
        destdir="${test_build_classes_dir}"
        classpath="${test_build_classes_dir}:
                   ${lib_class_path}:
                   ${pronghorn_libs_class_path}"
        debug="true"
        debuglevel="lines,vars,source"
        includeantruntime="false" />
  </target>


  <!-- RUNNING TESTS -->
  <target
      name="run_all"
      depends=
        "run_AddRemoveSwitch,run_SimulatedRoutingTable">
  </target>

  
  <!-- Single instance add/remove switch -->
  <target
      name="run_AddRemoveSwitch"
      depends="compile_ralph_tests"
      description="Add/remove switch from single pronghorn instance.">
    <java
        dir="${test_build_classes_dir}"
        classpath="${test_build_classes_dir}:
                   ${lib_class_path}:
                   ${proto_class_path}:
                   ${pronghorn_libs_class_path}"
        classname="${test_package}.SingleTest" fork="yes">
        <arg line="${args}"/>
    </java>
  </target>

  <!-- Simulate pushing routing table changes to hardware  -->
  <target
      name="run_SimulatedRoutingTable"
      depends="compile_ralph_tests"
      description="Add rtable entries for single pronghorn instance.">
    <java
        dir="${test_build_classes_dir}"
        classpath="${test_build_classes_dir}:
                   ${lib_class_path}:
                   ${proto_class_path}:
                   ${pronghorn_libs_class_path}"
        classname="${test_package}.SimulatedExtendedTest" fork="yes">
        <arg line="${args}"/>
    </java>
  </target>

  

  <!--
      Run tests without recompiling the ralph source to java:
      can make changes to emitted that persist.
  -->
  <target
      name="run_all_no_recompile"
      depends=
        "run_no_recompile_AddRemoveSwitch,
         run_no_recompile_SimulatedRoutingTable">
  </target>

  <target
      name="no_recompile"
      depends="init,compile_libs,ralph_to_byte_code"
      description="do not compile ralph to java, reuse files in ralph_emitted">
  </target>

  <!-- Single instance add/remove switch -->
  <target
      name="run_no_recompile_AddRemoveSwitch"
      depends="no_recompile"
      description="Add/remove switch from single pronghorn instance.">
    <java
        dir="${test_build_classes_dir}"
        classpath="${test_build_classes_dir}:
                   ${lib_class_path}:
                   ${proto_class_path}:
                   ${pronghorn_libs_class_path}"
        classname="${test_package}.SingleTest" fork="yes">
        <arg line="${args}"/>
    </java>
  </target>

  <!-- Simulate pushing routing table changes to hardware  -->
  <target
      name="run_no_recompile_SimulatedRoutingTable"
      depends="no_recompile"
      description="Add rtable entries for single pronghorn instance.">
    <java
        dir="${test_build_classes_dir}"
        classpath="${test_build_classes_dir}:
                   ${lib_class_path}:
                   ${proto_class_path}:
                   ${pronghorn_libs_class_path}"
        classname="${test_package}.SimulatedExtendedTest" fork="yes">
        <arg line="${args}"/>
    </java>
  </target>


  

  
  <!-- Delete the build directories -->
  <target name="clean" description="get rid of build dir">
    <delete dir="${test_build_classes_dir}"/>
    <delete dir="${test_ralph_emitted_dir}"/>
  </target>

  <target
      name="clean_all"
      depends="clean"
      description="get rid of build dir and all built libs">
    <ant antfile="${lib_build_path}/build.xml" target="clean" />
  </target>

  
</project>
